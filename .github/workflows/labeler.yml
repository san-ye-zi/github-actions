name: "Pull Request Labeler"

on:
  workflow_call:
    inputs:
      config-repo:
        description: 'Organization/repository for central configs (leave empty for local)'
        type: string
        required: false
        default: ''
      config-path:
        description: 'Path to the labeler configuration file'
        required: false
        type: string
        default: '.github/labeler.yml'
      sync-labels:
        description: 'Whether to remove labels when matching files are reverted'
        required: false
        default: true
        type: boolean

jobs:
  labeler:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      # 1. Checkout the central config repository ONLY if config-repo is provided
      - name: Checkout Central Config
        if: ${{ inputs.config-repo != '' }}
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.config-repo }}
          path: 'shared-config'

      # 2. Debug: list shared-config contents
      - name: List Shared Config Files
        if: ${{ inputs.config-repo != '' }}
        shell: bash
        run: |
          echo "== Root directory =="
          ls -la

          echo
          echo "== shared-config directory =="
          ls -la shared-config || echo "shared-config directory does not exist"

          echo
          echo "== Expected config path =="
          ls -la shared-config/${{ inputs.config-path }} || echo "Config file not found"

      # 2. Run the labeler
      - name: Labeler
        uses: actions/labeler@v5
        with:
          repo-token: "${{ secrets.GITHUB_TOKEN }}"
          # If config-repo is provided, use the 'shared-config' prefix. 
          # Otherwise, use the path directly (local repo).
          configuration-path: >-
            ${{ inputs.config-repo != '' 
                && format('shared-config/{0}', inputs.config-path) 
                || inputs.config-path }}
          sync-labels: ${{ inputs.sync-labels }}

# HOW TO USE THIS WORKFLOW
# name: "CI Labeling"

# on:
#   pull_request_target:

# jobs:
#   labeler:
#     # Replace 'owner/repo' with your shared workflow location
#     uses: san-ye-zi/github-actions/.github/workflows/labeler.yml@main
#     with:
#       config-path: '.github/custom-labels.yml'
#       config-repo: 'my-org/central-configs'
